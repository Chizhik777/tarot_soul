<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞—Ä–æ —Å –î—É—à–æ–π | –ï–ª–µ–Ω–∞</title>
    <!-- FAVICON (–õ—É–Ω–∞) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåô</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        void: '#020202', 
                        gold: {
                            100: '#F9F1D8',
                            300: '#E6C87C',
                            500: '#D4AF37', 
                            700: '#997B1E',
                            900: '#423206',
                        },
                    },
                    fontFamily: {
                        heading: ['Cinzel Decorative', 'serif'],
                        body: ['Cormorant Garamond', 'serif'],
                    },
                    backgroundImage: {
                        'gold-gradient': 'linear-gradient(135deg, #D4AF37 0%, #F9F1D8 50%, #997B1E 100%)',
                    },
                    animation: {
                        'spin-slow': 'spin 12s linear infinite',
                        'pulse-gold': 'pulseGold 3s infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                    },
                    keyframes: {
                        pulseGold: {
                            '0%, 100%': { boxShadow: '0 0 10px rgba(212, 175, 55, 0.2)' },
                            '50%': { boxShadow: '0 0 25px rgba(212, 175, 55, 0.6)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% center' },
                            '100%': { backgroundPosition: '200% center' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #000000;
            color: #E6C87C;
            overflow-x: hidden;
            cursor: none; 
            position: relative;
        }

        @media (hover: none) and (pointer: coarse) {
            body { cursor: auto !important; }
            #custom-cursor { display: none !important; }
            .btn-gold, .portal-container, .glass-panel, .cursor-pointer, input, textarea, button { cursor: pointer !important; }
        }

        #custom-cursor {
            position: fixed;
            width: 20px; height: 20px;
            background: radial-gradient(circle, #fff 0%, #D4AF37 50%, transparent 80%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px 5px rgba(212, 175, 55, 0.6);
            mix-blend-mode: screen;
            transition: width 0.2s, height 0.2s;
        }
        #custom-cursor.active {
            width: 40px; height: 40px;
            box-shadow: 0 0 40px 10px rgba(255, 215, 0, 0.8);
        }

        #preloader { transition: opacity 0.8s ease-out, visibility 0.8s; }
        #preloader.loaded { opacity: 0; visibility: hidden; }

        #chaos-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -3; background: #000; }
        #magic-dust { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; mix-blend-mode: screen; }

        .glass-panel {
            background: rgba(5, 5, 5, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        .tarot-card-wrapper { perspective: 1200px; }
        .tarot-card-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
        }
        .flipped .tarot-card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; inset: 0; backface-visibility: hidden; border-radius: 12px; border: 2px solid #997B1E; }
        .card-front { background: #0a0500; display: flex; align-items: center; justify-content: center; }
        .eye-symbol { width: 60px; height: 60px; border: 2px solid #D4AF37; border-radius: 0 70%; transform: rotate(45deg); position: relative; }
        .eye-symbol::after { content: ''; position: absolute; width: 24px; height: 24px; background: #D4AF37; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .card-back { background: linear-gradient(160deg, #1a1a1a 0%, #000000 100%); transform: rotateY(180deg); }

        .btn-gold {
            background: transparent; border: 1px solid #D4AF37; color: #D4AF37;
            position: relative; overflow: hidden; transition: all 0.4s ease;
            font-family: 'Cinzel Decorative', serif; letter-spacing: 0.1em; z-index: 1;
        }
        .btn-gold:hover { color: #000; background: #D4AF37; box-shadow: 0 0 30px rgba(212, 175, 55, 0.5); }

        .input-gold {
            width: 100%; background: rgba(0,0,0,0.5); border: 1px solid rgba(212, 175, 55, 0.3);
            color: #F9F1D8; padding: 12px; border-radius: 8px; outline: none; transition: all 0.3s;
        }
        .input-gold:focus { border-color: #D4AF37; box-shadow: 0 0 15px rgba(212, 175, 55, 0.2); }

        /* CHAT UI */
        #chat-btn {
            position: fixed; bottom: 30px; right: 30px; z-index: 100;
            width: 65px; height: 65px; border-radius: 50%;
            background: linear-gradient(135deg, #D4AF37, #F9F1D8);
            color: #000; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 40px rgba(212, 175, 55, 0.5);
            cursor: pointer !important; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #chat-btn:hover { transform: scale(1.1) rotate(10deg); }
        
        #chat-window {
            position: fixed; bottom: 110px; right: 30px; z-index: 110;
            width: 380px; max-width: calc(100vw - 60px); height: 550px; max-height: 80vh;
            display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,1);
        }

        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
        .chat-msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4; position: relative; }
        .msg-client { background: rgba(212, 175, 55, 0.15); align-self: flex-end; color: #F9F1D8; border-bottom-right-radius: 4px; border: 1px solid rgba(212, 175, 55, 0.2); }
        .msg-admin { background: rgba(255, 255, 255, 0.05); align-self: flex-start; color: #D4AF37; border-bottom-left-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .msg-system { background: rgba(212, 175, 55, 0.05); align-self: center; color: #E6C87C; font-size: 0.8rem; border: 1px dashed rgba(212, 175, 55, 0.3); text-align: center; border-radius: 10px; width: 90%; }
        
        .chat-img { max-width: 100%; border-radius: 10px; margin-top: 8px; border: 1px solid rgba(212, 175, 55, 0.3); }

        .time-slot { padding: 10px; border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 6px; text-align: center; cursor: pointer; background: rgba(0,0,0,0.3); transition: all 0.3s; font-size: 0.9rem; }
        .time-slot.selected { background: #D4AF37; color: #000; font-weight: bold; }
        .time-slot.disabled { opacity: 0.3; cursor: not-allowed; text-decoration: line-through; }

        #image-preview-container {
            position: absolute; bottom: 70px; left: 15px; right: 15px; 
            background: rgba(0,0,0,0.9); padding: 10px; border-radius: 10px; 
            display: flex; align-items: center; justify-content: space-between;
            border: 1px solid #D4AF37; z-index: 120;
        }

    </style>
</head>
<body class="min-h-screen flex flex-col font-body selection:bg-gold-500 selection:text-black">

    <div id="preloader" class="fixed inset-0 z-[9999] bg-black flex items-center justify-center">
        <div class="text-center">
            <i class="fas fa-moon text-6xl text-gold-500 animate-pulse-gold mb-4"></i>
            <h2 class="font-heading text-2xl text-gold-100 tracking-widest">Tarot Soul</h2>
        </div>
    </div>

    <div id="custom-cursor"></div>
    <canvas id="chaos-bg"></canvas>
    <canvas id="magic-dust"></canvas>

    <!-- HEADER -->
    <header class="fixed w-full z-50 top-0 left-0 bg-void/80 backdrop-blur-md border-b border-white/5">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-moon text-gold-500 text-xl"></i>
                <span class="font-heading text-xl text-gold-300">Tarot Soul</span>
            </div>
            <a href="#booking-section" class="btn-gold px-6 py-2 rounded-full text-xs font-bold tracking-widest uppercase hover:text-black transition-all">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</a>
        </div>
    </header>

    <!-- HERO -->
    <section class="min-h-[70vh] flex flex-col items-center justify-center text-center px-4 relative pt-32">
        <h1 class="font-heading text-5xl md:text-8xl text-gold-glow animate-float relative z-10">–¢–∞—Ä–æ —Å –î—É—à–æ–π</h1>
        <p class="text-xl md:text-2xl text-gold-100 italic max-w-2xl font-light mb-12 relative z-10">"–¢–∞–º, –≥–¥–µ –¢—å–º–∞ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Å–æ –°–≤–µ—Ç–æ–º, —Ä–æ–∂–¥–∞–µ—Ç—Å—è –ò—Å—Ç–∏–Ω–∞."</p>
    </section>

    <!-- CONTENT -->
    <div class="container mx-auto px-4 pb-20 max-w-5xl space-y-24 relative z-10">
        <!-- 1. CARDS -->
        <section>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 h-[350px]" id="tarot-deck"></div>
            <div id="tarot-result" class="hidden glass-panel p-8 mt-8 text-center max-w-2xl mx-auto border-gold-500/30">
                <h3 id="result-title" class="font-heading text-3xl text-gold-100 mb-4"></h3>
                <p id="result-desc" class="text-lg text-gray-300 italic mb-8"></p>
                <button onclick="window.resetTarot()" class="btn-gold px-8 py-3 rounded-full text-sm">–î—Ä—É–≥–æ–π –≤–æ–ø—Ä–æ—Å</button>
            </div>
        </section>

        <!-- 2. BOOKING -->
        <section id="booking-section" class="scroll-mt-32">
            <div class="text-center mb-12">
                <h2 class="font-heading text-3xl md:text-4xl text-gold-300 mb-2">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ä–∞—Å–∫–ª–∞–¥</h2>
                <p class="text-sm text-gray-400 uppercase tracking-widest">–û–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ</p>
            </div>

            <div class="glass-panel p-10 max-w-3xl mx-auto border-gold-500/40">
                <form id="booking-form" class="space-y-8" onsubmit="window.submitBooking(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-[10px] uppercase text-gold-500 tracking-widest ml-1">–í–∞—à–µ –ò–º—è</label>
                            <input type="text" id="book-name" required class="input-gold" placeholder="–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] uppercase text-gold-500 tracking-widest ml-1">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞</label>
                            <input type="date" id="book-date" required class="input-gold" oninput="window.generateTimeSlots(this.value)">
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <label class="text-[10px] uppercase text-gold-500 tracking-widest ml-1">–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è</label>
                        <div id="time-slots-container" class="grid grid-cols-3 md:grid-cols-5 gap-3">
                             <div class="col-span-full text-center text-gray-600 text-sm py-4">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</div>
                        </div>
                        <input type="hidden" id="selected-time" required>
                    </div>

                    <div class="space-y-2">
                        <label class="text-[10px] uppercase text-gold-500 tracking-widest ml-1">–°—É—Ç—å –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞</label>
                        <textarea id="book-notes" rows="3" class="input-gold" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é..."></textarea>
                    </div>

                    <button type="submit" id="submit-btn" class="w-full btn-gold py-5 rounded-lg font-heading text-xl font-bold shadow-xl">
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å
                    </button>
                    <p id="time-error" class="text-red-500 text-center text-sm hidden font-bold">‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è!</p>
                </form>
            </div>
        </section>

        <!-- REVIEWS -->
        <section id="reviews-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></section>
    </div>

    <!-- LIVE CHAT WIDGET (Hidden by default with 'hidden') -->
    <div id="chat-btn" class="hidden" onclick="window.toggleChat()">
        <i class="fas fa-comment-dots text-2xl"></i>
    </div>

    <div id="chat-window" class="hidden glass-panel flex flex-col border-gold-500/50 shadow-2xl overflow-hidden bg-black/95">
        <div class="p-4 border-b border-gold-500/20 bg-gold-900/20 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse shadow-[0_0_10px_#22c55e]"></div>
                <span class="font-heading text-sm text-gold-300" id="chat-header-title">–î–∏–∞–ª–æ–≥ —Å –ï–ª–µ–Ω–æ–π</span>
            </div>
            <button onclick="window.toggleChat()" class="text-gray-500 hover:text-white transition"><i class="fas fa-times"></i></button>
        </div>
        
        <div id="chat-admin-dashboard" class="hidden flex-1 overflow-y-auto p-4 space-y-2">
            <p class="text-[10px] uppercase text-gray-500 mb-3 tracking-widest border-b border-white/5 pb-2">–°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤:</p>
            <div id="admin-user-list" class="space-y-2"></div>
        </div>

        <div id="chat-messages" class="chat-messages bg-void/50">
            <div class="msg-admin chat-msg">–°–≤–µ—Ç–ª—ã—Ö –í–∞–º –º—ã—Å–ª–µ–π! ‚ú® –ó–¥–µ—Å—å –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ —Ä–∞—Å–∫–ª–∞–¥–∞ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–æ–±—â–∞—Ç—å—Å—è. –Ø –æ—Ç–≤–µ—á—É –í–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</div>
        </div>

        <!-- Image Preview -->
        <div id="image-preview-container" class="hidden">
            <div class="flex items-center gap-3">
                <i class="fas fa-image text-gold-500"></i>
                <span class="text-[10px] text-white truncate max-w-[200px]" id="preview-filename"></span>
            </div>
            <button onclick="window.clearImagePreview()" class="text-red-500 text-xs hover:text-white"><i class="fas fa-trash"></i></button>
        </div>

        <div class="p-4 border-t border-gold-500/10 bg-black flex gap-3 items-center">
            <label class="cursor-pointer text-gold-500 hover:text-white transition text-lg px-1">
                <i class="fas fa-paperclip"></i>
                <input type="file" id="chat-file-input" class="hidden" accept="image/*" onchange="window.handleImageSelect(event)">
            </label>
            <input type="text" id="chat-input" class="flex-1 bg-white/5 rounded-full px-5 py-2 text-sm text-gold-100 outline-none border border-white/5 focus:border-gold-500/50" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') window.sendChatMessage()">
            <button onclick="window.sendChatMessage()" class="w-10 h-10 rounded-full bg-gold-500 text-black flex items-center justify-center hover:bg-white transition shadow-lg">
                <i class="fas fa-paper-plane text-xs"></i>
            </button>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="mt-20 py-12 text-center relative border-t border-white/5">
        <div class="text-gold-700 text-2xl font-heading mb-6 tracking-widest">Tarot Soul</div>
        <p class="text-gray-800 text-[10px] uppercase tracking-widest cursor-pointer hover:text-gold-500 transition-all" onclick="window.enableAdminMode()">
            &copy; 2026 –ï–ª–µ–Ω–∞. –°–¥–µ–ª–∞–Ω–æ —Å –¥—É—à–æ–π.
        </p>
    </footer>

    <!-- SUCCESS MODAL (Local) -->
    <div id="success-modal" class="fixed inset-0 z-[120] hidden bg-black/95 flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm p-10 text-center shadow-[0_0_80px_rgba(212,175,55,0.3)] border-gold-500/50">
            <div class="text-5xl text-gold-500 mb-6"><i class="fas fa-check-circle"></i></div>
            <h3 class="font-heading text-2xl text-gold-300 mb-4">–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã!</h3>
            <p class="text-gray-300 text-sm mb-10 leading-relaxed">–î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ —É–∂–µ –≤ —á–∞—Ç–µ. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ –≤–∞—à–µ–≥–æ —Ä–∞—Å–∫–ª–∞–¥–∞ —Ç–∞–º –∂–µ –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞. ‚ú®</p>
            <button onclick="window.closeSuccessAndOpenChat()" class="w-full btn-gold py-4 rounded-lg font-bold">–ü–µ—Ä–µ–π—Ç–∏ –≤ —á–∞—Ç</button>
        </div>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, getDocs, query } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        let app, auth, db;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let currentUser = null;
        let isAdminMode = false;
        let activeAdminChatUser = null;
        let pendingImageBase64 = null;

        // Init Firebase
        try {
            if (typeof __firebase_config !== 'undefined') {
                const firebaseConfig = JSON.parse(__firebase_config);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (e) { console.error("Firebase fail"); }

        async function initAuth() {
            if (!auth) return;
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                     await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        loadReviews();
                        loadChatMessages();
                    }
                });
            } catch (e) {}
        }

        // --- CHAT SYSTEM ---
        window.toggleChat = () => {
            const win = document.getElementById('chat-window');
            win.classList.toggle('hidden');
            if(!win.classList.contains('hidden')) scrollToBottom();
        };

        window.handleImageSelect = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 800000) { 
                alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ç–æ –¥–æ 800 –ö–±.");
                return;
            }
            const reader = new FileReader();
            reader.onload = (event) => {
                pendingImageBase64 = event.target.result;
                document.getElementById('image-preview-container').classList.remove('hidden');
                document.getElementById('preview-filename').innerText = file.name;
            };
            reader.readAsDataURL(file);
        };

        window.clearImagePreview = () => {
            pendingImageBase64 = null;
            document.getElementById('image-preview-container').classList.add('hidden');
            document.getElementById('chat-file-input').value = '';
        };

        window.sendChatMessage = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text && !pendingImageBase64) return;
            if(!db || !currentUser) return;

            const targetUid = isAdminMode ? activeAdminChatUser : currentUser.uid;
            if(!targetUid) return;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), {
                    text: text,
                    image: pendingImageBase64 || null,
                    uid: targetUid,
                    name: document.getElementById('book-name').value || "–ö–ª–∏–µ–Ω—Ç",
                    isAdmin: isAdminMode,
                    timestamp: serverTimestamp()
                });
                input.value = '';
                window.clearImagePreview();
            } catch (e) { console.error("Send failed"); }
        };

        function loadChatMessages() {
            if (!db || !currentUser) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), (snapshot) => {
                const msgs = [];
                snapshot.forEach(doc => msgs.push(doc.data()));
                msgs.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                const container = document.getElementById('chat-messages');
                const targetUid = isAdminMode ? activeAdminChatUser : currentUser.uid;
                if(!targetUid) return;

                const filtered = msgs.filter(m => m.uid === targetUid);
                
                container.innerHTML = (filtered.length > 0) ? filtered.map(m => {
                    const isMyMsg = (isAdminMode && m.isAdmin) || (!isAdminMode && !m.isAdmin);
                    const isSystem = m.type === 'system';
                    
                    if(isSystem) return `<div class="chat-msg msg-system">${m.text}</div>`;
                    
                    return `
                        <div class="chat-msg ${isMyMsg ? 'msg-client' : 'msg-admin'}">
                            ${m.text ? `<div>${m.text}</div>` : ''}
                            ${m.image ? `<img src="${m.image}" class="chat-img" onclick="window.openFullImage(this.src)">` : ''}
                        </div>
                    `;
                }).join('') : `<div class="msg-admin chat-msg">–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ –ø–µ—Ä–≤—ã–º! ‚ú®</div>`;
                scrollToBottom();
            });
        }

        window.openFullImage = (src) => {
            const modal = document.getElementById('image-modal');
            document.getElementById('modal-image').src = src;
            modal.classList.remove('hidden');
        };

        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;
        }

        // --- ADMIN ---
        window.enableAdminMode = () => {
            const pass = prompt("–î–æ—Å—Ç—É–ø –¥–ª—è –ï–ª–µ–Ω—ã. –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:");
            if(pass === "elena2026") {
                isAdminMode = true;
                // Show chat button for admin
                document.getElementById('chat-btn').classList.remove('hidden');
                document.getElementById('chat-admin-dashboard').classList.remove('hidden');
                document.getElementById('chat-messages').classList.add('hidden');
                document.getElementById('chat-header-title').innerText = "–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å";
                loadAdminDashboard();
                if(document.getElementById('chat-window').classList.contains('hidden')) window.toggleChat();
            }
        };

        function loadAdminDashboard() {
            if (!db) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), (snapshot) => {
                const users = {};
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    if(!msg.isAdmin) { users[msg.uid] = msg.name || "–ö–ª–∏–µ–Ω—Ç"; }
                });
                
                const list = document.getElementById('admin-user-list');
                list.innerHTML = Object.keys(users).map(uid => `
                    <div onclick="window.openUserChat('${uid}', '${users[uid]}')" class="p-4 glass-panel cursor-pointer hover:bg-gold-500/10 flex items-center justify-between border-white/5">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gold-900 border border-gold-500/30 flex items-center justify-center text-xs text-gold-300 font-bold">${users[uid][0]}</div>
                            <span class="text-sm font-bold text-gold-100">${users[uid]}</span>
                        </div>
                        <i class="fas fa-chevron-right text-[10px] opacity-30"></i>
                    </div>
                `).join('');
            });
        }

        window.openUserChat = (uid, name) => {
            activeAdminChatUser = uid;
            document.getElementById('chat-admin-dashboard').classList.add('hidden');
            document.getElementById('chat-messages').classList.remove('hidden');
            document.getElementById('chat-header-title').innerHTML = `<button onclick="window.backToAdminList()" class="mr-2"><i class="fas fa-arrow-left"></i></button> –ß–∞—Ç: ${name}`;
            loadChatMessages();
        };

        window.backToAdminList = () => {
            activeAdminChatUser = null;
            document.getElementById('chat-admin-dashboard').classList.remove('hidden');
            document.getElementById('chat-messages').classList.add('hidden');
            document.getElementById('chat-header-title').innerText = "–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å";
        };

        // --- BOOKING ---
        window.generateTimeSlots = async function(dateString) {
            const container = document.getElementById('time-slots-container');
            const hiddenInput = document.getElementById('selected-time');
            if(!dateString) return;
            
            const renderLayout = (booked = []) => {
                container.innerHTML = '';
                hiddenInput.value = '';
                const parts = dateString.split('-');
                const selDate = new Date(parts[0], parts[1]-1, parts[2]);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const isToday = selDate.getTime() === today.getTime();
                const curHour = now.getHours();

                for(let h = 11; h <= 19; h++) {
                    const label = `${h}:00`;
                    const isDisabled = (selDate < today) || (isToday && h <= curHour) || booked.includes(label);
                    const btn = document.createElement('div');
                    btn.className = `time-slot ${isDisabled ? 'disabled' : ''}`;
                    btn.textContent = label;
                    if (!isDisabled) {
                        btn.onclick = () => {
                            Array.from(container.children).forEach(c => c.classList.remove('selected'));
                            btn.classList.add('selected');
                            hiddenInput.value = label;
                            document.getElementById('time-error').classList.add('hidden');
                        };
                    }
                    container.appendChild(btn);
                }
            };
            renderLayout([]);
            if (db) {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'));
                const booked = [];
                snap.forEach(d => { if(d.data().date === dateString) booked.push(d.data().time); });
                renderLayout(booked);
            }
        };

        window.submitBooking = async function(e) {
            e.preventDefault();
            const name = document.getElementById('book-name').value;
            const date = document.getElementById('book-date').value;
            const time = document.getElementById('selected-time').value;
            const notes = document.getElementById('book-notes').value;

            if(!time) { document.getElementById('time-error').classList.remove('hidden'); return; }

            if (db && currentUser) {
                try {
                    const bookingData = { name, date, time, notes, uid: currentUser.uid, createdAt: serverTimestamp() };
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), bookingData);
                    
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), {
                        type: 'system',
                        text: `üîÆ –ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨\n–ò–º—è: ${name}\n–î–∞—Ç–∞: ${date} –≤ ${time}\n–í–æ–ø—Ä–æ—Å: ${notes || "–Ω–µ —É–∫–∞–∑–∞–Ω"}`,
                        uid: currentUser.uid,
                        name: name,
                        isAdmin: false,
                        timestamp: serverTimestamp()
                    });
                    
                    document.getElementById('success-modal').classList.remove('hidden');
                    document.getElementById('booking-form').reset();
                } catch (e) { alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏"); }
            }
        };

        window.closeSuccessAndOpenChat = () => {
            document.getElementById('success-modal').classList.add('hidden');
            // Reveal and open chat button for user after booking
            document.getElementById('chat-btn').classList.remove('hidden');
            if(document.getElementById('chat-window').classList.contains('hidden')) window.toggleChat();
        };

        function loadReviews() {
            if (!db) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'reviews'), (snap) => {
                const reviews = [];
                snap.forEach(doc => reviews.push({ id: doc.id, ...doc.data() }));
                reviews.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                document.getElementById('reviews-list').innerHTML = reviews.slice(0, 4).map(r => `
                    <div class="glass-panel p-6 animate-float border-gold-500/10">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-8 h-8 rounded-full bg-gold-900 border border-gold-500/20 flex items-center justify-center text-gold-500 text-xs font-bold">${r.name[0]}</div>
                            <span class="text-sm font-bold text-gold-100">${r.name}</span>
                        </div>
                        <p class="text-xs text-gray-400 italic leading-relaxed">"${r.text}"</p>
                    </div>
                `).join('');
            });
        }

        initAuth();
    </script>

    <!-- VISUALS -->
    <script>
        (function() {
            window.addEventListener('load', () => { setTimeout(() => { document.getElementById('preloader').classList.add('loaded'); }, 1000); });
            const c1 = document.getElementById('chaos-bg'), ctx1 = c1.getContext('2d');
            const c2 = document.getElementById('magic-dust'), ctx2 = c2.getContext('2d');
            let canvasW, canvasH;
            function resize() { canvasW = c1.width = c2.width = window.innerWidth; canvasH = c1.height = c2.height = window.innerHeight; }
            window.onresize = resize; resize();

            let particleList = [];
            class MagicParticleEffect {
                constructor() { this.x = Math.random() * canvasW; this.y = Math.random() * canvasH; this.s = Math.random() * 2; this.v = Math.random() * 0.5; }
                draw() { 
                    ctx2.fillStyle = '#D4AF37'; ctx2.globalAlpha = 0.3; ctx2.beginPath(); ctx2.arc(this.x, this.y, this.s, 0, 7); ctx2.fill(); 
                    this.y -= this.v; if(this.y < 0) this.y = canvasH; 
                }
            }
            for(let i=0; i<100; i++) particleList.push(new MagicParticleEffect());
            function anim() {
                ctx1.fillStyle = '#000'; ctx1.fillRect(0,0,canvasW,canvasH);
                ctx2.clearRect(0,0,canvasW,canvasH);
                particleList.forEach(p => p.draw());
                requestAnimationFrame(anim);
            }
            anim();

            const tarotData = [
                { name: "–¢—É–∑ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", desc: "–î–≤–µ—Ä—å –∫ —Ä–µ—Å—É—Ä—Å–∞–º –æ—Ç–∫—Ä—ã—Ç–∞. –í—Å–µ–ª–µ–Ω–Ω–∞—è –¥–∞—Ä–∏—Ç —à–∞–Ω—Å.", icon: "fas fa-coins" },
                { name: "–í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞", desc: "–°–ª—É—à–∞–π –∏–Ω—Ç—É–∏—Ü–∏—é. –û—Ç–≤–µ—Ç —Å–∫—Ä—ã—Ç –≤–Ω—É—Ç—Ä–∏ —Ç–µ–±—è.", icon: "fas fa-scroll" },
                { name: "–°–æ–ª–Ω—Ü–µ", desc: "–ê–±—Å–æ–ª—é—Ç–Ω—ã–π —É—Å–ø–µ—Ö –∏ —è—Å–Ω–æ—Å—Ç—å –≤–æ –≤—Å–µ–º.", icon: "fas fa-sun" },
                { name: "–ó–≤–µ–∑–¥–∞", desc: "–ù–∞–¥–µ–∂–¥–∞ –æ–ø—Ä–∞–≤–¥–∞–µ—Ç—Å—è. –¢–≤–æ–π –ø—É—Ç—å –æ—Å–≤–µ—â–µ–Ω.", icon: "fas fa-star" }
            ];
            const deck = document.getElementById('tarot-deck');
            function initDeck() {
                if(!deck) return;
                deck.innerHTML = '';
                for(let i=0; i<3; i++) {
                    const c = document.createElement('div');
                    c.className = 'tarot-card-wrapper cursor-pointer flex-1';
                    c.innerHTML = `<div class="tarot-card-inner h-full w-full mx-auto"><div class="card-face card-front"><div class="eye-symbol"></div></div><div class="card-face card-back flex flex-col items-center justify-center p-4"></div></div>`;
                    c.onclick = () => {
                        if(c.classList.contains('flipped')) return;
                        const card = tarotData[Math.floor(Math.random()*tarotData.length)];
                        c.querySelector('.card-back').innerHTML = `<i class="${card.icon} text-4xl text-gold-500 mb-4"></i><div class="text-sm font-heading text-gold-100 text-center">${card.name}</div>`;
                        c.classList.add('flipped');
                        document.getElementById('result-title').innerText = card.name;
                        document.getElementById('result-desc').innerText = card.desc;
                        document.getElementById('tarot-result').classList.remove('hidden');
                    };
                    deck.appendChild(c);
                }
            }
            window.resetTarot = () => { document.getElementById('tarot-result').classList.add('hidden'); initDeck(); };
            initDeck();

            const cursor = document.getElementById('custom-cursor');
            document.onmousemove = (e) => { if(cursor) { cursor.style.left = e.clientX+'px'; cursor.style.top = e.clientY+'px'; } };
        })();
    </script>
    
    <div id="image-modal" class="fixed inset-0 z-[200] hidden bg-black/95 flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
        <img id="modal-image" src="" class="max-h-full max-w-full rounded-lg shadow-2xl border border-gold-500/20">
    </div>
</body>
</html>